事前準備としてChatGPTに適当に生成してもらったテーブルとデータ(`18-0-generate.sql`)を作成する。ユーザー情報テーブルにはたくさんのカラムがあるがアプリケーションではそのうちの一部のカラムのみを頻繁に参照したい、複数テーブルを結合してまとめた結果を簡単に扱いたい、といった状況がしばしば発生する。こういった場合、ビューを利用できる。ビューとは、テーブルから必要なデータだけを取り出し、仮想的なテーブルとして定義する仕組みである。あくまで保存しているのは`SELECT`文であり、実際のデータとして保持するわけではないのでストレージを殆ど使用しない(ビュー定義のメタデータ分ストレージは使用される)。以下のクエリでは注文と支払い情報を結合したビューを作成している。ビューを作成しておけばテーブルと同じように簡単に参照できる。
```
-- 注文と支払い情報を結合したビューを作成
mysql> create view view_order_payments as
    -> select
    ->     o.order_id,
    ->     u.username as customer,
    ->     p.name as product,
    ->     o.quantity,
    ->     p.price,
    ->     (o.quantity * p.price) as total_price,
    ->     py.payment_method,
    ->     py.payment_date
    -> from orders as o
    -> join users as u on o.user_id = u.user_id
    -> join products as p on o.product_id = p.product_id
    -> left join payments as py on o.order_id = py.order_id;
Query OK, 0 rows affected (0.02 sec)

-- テーブルと同じようにビューを参照できる。
mysql> select * from view_order_payments;
+----------+----------+----------+----------+---------+-------------+----------------+---------------------+
| order_id | customer | product  | quantity | price   | total_price | payment_method | payment_date        |
+----------+----------+----------+----------+---------+-------------+----------------+---------------------+
|        1 | alice    | Laptop   |        1 | 1200.00 |     1200.00 | credit_card    | 2025-03-21 14:52:20 |
|        2 | bob      | Mouse    |        2 |   25.50 |       51.00 | paypal         | 2025-03-21 14:52:20 |
|        3 | charlie  | Keyboard |        1 |   75.00 |       75.00 | bank_transfer  | 2025-03-21 14:52:20 |
+----------+----------+----------+----------+---------+-------------+----------------+---------------------+
```
また、セキュリティの観点からユーザーテーブルをそのまま公開すると不必要な個人情報まで見えてしまうため、セキュリティの観点から好ましくないといった場合にも利用できる。以下のクエリでは`users`テーブルから`password_hash`を除いたビューを作成している。このビューを使用すれば公開したいカラムのみを公開することができる。
```
-- 公開していいカラムのみを持ったビューを作成
mysql> create view view_users as
    -> select
    ->     user_id,
    ->     username,
    ->     email,
    ->     created_at
    -> from users;
Query OK, 0 rows affected (0.01 sec)

mysql> select * from view_users where user_id = 2;
+---------+----------+-----------------+---------------------+
| user_id | username | email           | created_at          |
+---------+----------+-----------------+---------------------+
|       2 | bob      | bob@example.com | 2025-03-21 14:52:20 |
+---------+----------+-----------------+---------------------+
```
ビューのもとになったテーブルを更新すればビューも更新される。
```
-- 更新前のビューを確認
mysql> select * from view_users where user_id = 2;
+---------+----------+-----------------+---------------------+
| user_id | username | email           | created_at          |
+---------+----------+-----------------+---------------------+
|       2 | bob      | bob@example.com | 2025-03-21 14:52:20 |
+---------+----------+-----------------+---------------------+

-- ビューのもとになったテーブルを更新
mysql> update users
    -> set username = "baden"
    -> where user_id = 2;
Query OK, 1 row affected (0.01 sec)
Rows matched: 1  Changed: 1  Warnings: 0

-- 更新後のビューでもレコードが更新されている
mysql> select * from view_users where user_id = 2;
+---------+----------+-----------------+---------------------+
| user_id | username | email           | created_at          |
+---------+----------+-----------------+---------------------+
|       2 | baden    | bob@example.com | 2025-03-21 14:52:20 |
+---------+----------+-----------------+---------------------+
1 row in set (0.00 sec)
```
ビューを作成する際には以下の注意点がある。
##### パフォーマンス上の課題
ビューを参照する際は保存された`SELECT`文が実行されてテーブルデータが取得されるという仕組みのため、複雑なクエリを含むビューを多用するとパフォーマンスが低下する恐れがある。

##### ビューとテーブルの取り違えリスク
テーブルとビューを取り違えると思ったよりパフォーマンスが出なかったり、参照できてはいけないカラムが参照できセキュリティ上に問題が出たりすつ。ビューとテーブルを取り違えないよう明らかにビューであるような命名を心がける。

##### テーブル構造の変更に伴う影響
カラム名が変わったり、カラムが削除されたりで、ビューの元となるテーブルのスキーマが大きく変更されると、ビュー自体の定義が正しく機能しなくなる恐れがある。

##### ネストしたビューのリスク
技術的にはビューの定義の中に別のビューを含めることは可能である。複雑なロジックを持つビューを他のビューでも使いまわすことでクエリの重複を避けられるというメリットがある。一方、クエリ実行時に多層的な展開が行われパフォーマンスが低下する、問題が起こった時に原因を特定しづらくなり保守性が下がる、ビューの依存関係が複雑になり管理が煩雑になるなどのデメリットがある。ビューをネストさせる際には必要最小限になるよう抑える。

ビューを作成する際にはアルゴリズムを指定できる。明示的に指定しなければMySQLの最適化に従って自動的にアルゴリズムが決定されるため、明示する場面は少ないかもしれないが、ビューの目的に応じてアルゴリズムを検討するのもよい。指定できるアルゴリズムには以下のものがある。詳細を知りたい場合は[25.5.2 ビュー処理アルゴリズム](https://dev.mysql.com/doc/refman/8.0/ja/view-algorithms.html)を参照する。

##### MERGE
ビュー定義の`SELECT`文を、ビューを使用する`SELECT`文にマージして実行する。単純なビュー(単一テーブル参照、サブクエリ無、集計無)ではパフォーマンス面で有利になることが多い。

##### TEMPTABLE
ビューの内容をTemporary Tableとして作成する。

##### UNDEFINED
アルゴリズムを明示せずにビューを作成した場合と同じ挙動をする。


条件を満たせばビューを経由してテーブルを更新することも可能だが、基本的にはデータの抽象化、セキュリティ向上、複雑なクエリの簡略化などのために利用され、更新を目的としない場合が多い。更新が必要な場合は[25.5.3 更新可能および挿入可能なビュー](https://dev.mysql.com/doc/refman/8.0/ja/view-updatability.html)で更新可能な条件を確認の上でビューを設計する。