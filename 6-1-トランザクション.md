事前準備としてChatGPTに適当に生成してもらったテーブルとデータ(`6-0-generate.sql`)を作成する。データベースで複数の処理を行う際、一連の処理を1つの単位にまとめることがある。例えば、銀行口座間の資金移動を考える。Aさんの口座からBさんの口座に資金を移す場合、Aさんの口座からは減額され、その後Bさんの口座は増額される。もしAさんの口座から減額された直後にエラーが発生し処理が中断されると、Aさんの口座は減額されるがBさんの口座は増額されない。これを防ぐためには増額と減額を1つの単位として扱い、すべての操作が成功するか、または失敗して取り消されるかのどちらかで処理される必要がある。このように処理をまとめたものをトランザクションと呼ぶ。トランザクションは通常以下の4つの特性(ACID特性と呼ばれる)を満たすよう設計される。
##### Atomicity(原子性)
トランザクション内のすべての操作は一つの単位として扱われ、すべての処理が完了するか全く処理が行われないかのどちらかである。途中でエラーが発生した場合トランザクション内部で行われたすべての変更が取り消される。
##### Consistency(一貫性)
トランザクションが始まる前と後でデータベースは正しい状態であることを保つ。ここでいう正しい状態とは、データ型の制約や一意性の制約などすべての制約が守られている状態のことである。
##### Isolation（独立性）
複数のトランザクションが同時に実行される場合でも、互いにトランザクションは影響を受けない。
##### Durability（持続性）
トランザクションが完了すると、その結果は永久に保存され、データベースに障害が発生しても失われることはない。

トランザクションは`START TRANSACTION`で開始する。トランザクションを完了してDBに反映されるには`COMMIT`を用いる。以下のコマンドではセッションを2つ用いているため、それぞれどちらのセッションで実行されたかも記載している。

```
-- トランザクション開始
mysql> start transaction; -- セッション1
Query OK, 0 rows affected (0.00 sec)

-- Aliceの口座から500円減額
mysql> update bank_accounts set balance = balance - 500 where account_name = "Alice"; -- セッション1
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

-- Bobの口座に500円加算
mysql> update bank_accounts set balance = balance + 500 where account_name = "Bob"; -- セッション1
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

-- コミットする前に現在の状態を確認
mysql> select * from bank_accounts; -- セッション1
+------------+--------------+---------+---------------------+
| account_id | account_name | balance | updated_at          |
+------------+--------------+---------+---------------------+
|          1 | Alice        |  500.00 | 2025-02-18 15:34:30 |
|          2 | Bob          | 2000.00 | 2025-02-18 15:35:10 |
|          3 | Charlie      | 2000.00 | 2025-02-18 14:55:36 |
+------------+--------------+---------+---------------------+
3 rows in set (0.00 sec)

-- 別のターミナルを開いてログイン（=別セッションを開く）し、レコードを確認するとトランザクションが反映されていない
mysql> select * from bank_accounts; -- セッション2
+------------+--------------+---------+---------------------+
| account_id | account_name | balance | updated_at          |
+------------+--------------+---------+---------------------+
|          1 | Alice        | 1000.00 | 2025-02-18 14:55:36 |
|          2 | Bob          | 1500.00 | 2025-02-18 14:55:36 |
|          3 | Charlie      | 2000.00 | 2025-02-18 14:55:36 |
+------------+--------------+---------+---------------------+

mysql> commit;
Query OK, 0 rows affected (0.01 sec)

-- commitするとトランザクションが反映される。
mysql> select * from bank_accounts; -- セッション1
+------------+--------------+---------+---------------------+
| account_id | account_name | balance | updated_at          |
+------------+--------------+---------+---------------------+
|          1 | Alice        |  500.00 | 2025-02-18 15:34:30 |
|          2 | Bob          | 2000.00 | 2025-02-18 15:35:10 |
|          3 | Charlie      | 2000.00 | 2025-02-18 14:55:36 |
+------------+--------------+---------+---------------------+

-- 別のセッションでもトランザクションが反映されている。
mysql> select * from bank_accounts; -- セッション2
+------------+--------------+---------+---------------------+
| account_id | account_name | balance | updated_at          |
+------------+--------------+---------+---------------------+
|          1 | Alice        |  500.00 | 2025-02-18 15:34:30 |
|          2 | Bob          | 2000.00 | 2025-02-18 15:35:10 |
|          3 | Charlie      | 2000.00 | 2025-02-18 14:55:36 |
+------------+--------------+---------+---------------------+
3 rows in set (0.00 sec)
```
トランザクションを破棄してDBを元の状態に戻すには`ROLLEBACK`を用いる。データベースサーバーとの接続が途中で切れても`ROLLBACK`が実行される。
```
mysql> start transaction;
Query OK, 0 rows affected (0.00 sec)

mysql> select * from bank_accounts;
+------------+--------------+---------+---------------------+
| account_id | account_name | balance | updated_at          |
+------------+--------------+---------+---------------------+
|          1 | Alice        |  500.00 | 2025-02-18 15:34:30 |
|          2 | Bob          | 2000.00 | 2025-02-18 15:35:10 |
|          3 | Charlie      | 2000.00 | 2025-02-18 14:55:36 |
+------------+--------------+---------+---------------------+
3 rows in set (0.00 sec)

mysql> update bank_accounts set balance = balance + 500 where account_name = "Alice";
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql> update bank_accounts set balance = balance - 500 where account_name = "Bob";
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql> select * from bank_accounts;
+------------+--------------+---------+---------------------+
| account_id | account_name | balance | updated_at          |
+------------+--------------+---------+---------------------+
|          1 | Alice        | 1000.00 | 2025-02-18 15:45:22 |
|          2 | Bob          | 1500.00 | 2025-02-18 15:45:52 |
|          3 | Charlie      | 2000.00 | 2025-02-18 14:55:36 |
+------------+--------------+---------+---------------------+
3 rows in set (0.00 sec)

mysql> rollback;
Query OK, 0 rows affected (0.01 sec)

mysql> select * from bank_accounts;
+------------+--------------+---------+---------------------+
| account_id | account_name | balance | updated_at          |
+------------+--------------+---------+---------------------+
|          1 | Alice        |  500.00 | 2025-02-18 15:34:30 |
|          2 | Bob          | 2000.00 | 2025-02-18 15:35:10 |
|          3 | Charlie      | 2000.00 | 2025-02-18 14:55:36 |
+------------+--------------+---------+---------------------+
```

多くのデータベースでは個々のSQL文が実行されるたびに自動的にトランザクションが開始され、文の実行が完了すると同時に自動的にコミットされる。これをオートコミットという。このモードでは、明示的に`START TRANSACTION`を実行しない限り各SQL文はその都度即時反映される。以下のコマンドでオートコミット状態化を確認できる。
```
mysql> show variables where variable_name="autocommit";
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| autocommit    | ON    |
+---------------+-------+
```
下記のコマンドでオートコミットをオフにできる。なお、無効になるのはそのセッション中のみである。
```
mysql> set autocommit = 0;
Query OK, 0 rows affected (0.01 sec)

mysql> show variables where variable_name="autocommit";
+---------------+-------+
| Variable_name | Value |
+---------------+-------+
| autocommit    | OFF   |
+---------------+-------+

mysql> select * from bank_accounts;
+------------+--------------+---------+---------------------+
| account_id | account_name | balance | updated_at          |
+------------+--------------+---------+---------------------+
|          1 | Alice        |  500.00 | 2025-02-18 15:34:30 |
|          2 | Bob          | 2000.00 | 2025-02-18 15:35:10 |
|          3 | Charlie      | 2000.00 | 2025-02-18 14:55:36 |
+------------+--------------+---------+---------------------+
3 rows in set (0.00 sec)

mysql> update bank_accounts set balance = balance - 500 where account_name = "Bob";
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

mysql> select * from bank_accounts;
+------------+--------------+---------+---------------------+
| account_id | account_name | balance | updated_at          |
+------------+--------------+---------+---------------------+
|          1 | Alice        |  500.00 | 2025-02-18 15:34:30 |
|          2 | Bob          | 1500.00 | 2025-02-19 13:53:03 |
|          3 | Charlie      | 2000.00 | 2025-02-18 14:55:36 |
+------------+--------------+---------+---------------------+
3 rows in set (0.00 sec)

mysql> rollback; -- 明示的にSTART TRACSACTIONを指定していないがロールバック可能
Query OK, 0 rows affected (0.00 sec)

mysql> select * from bank_accounts;
+------------+--------------+---------+---------------------+
| account_id | account_name | balance | updated_at          |
+------------+--------------+---------+---------------------+
|          1 | Alice        |  500.00 | 2025-02-18 15:34:30 |
|          2 | Bob          | 2000.00 | 2025-02-18 15:35:10 |
|          3 | Charlie      | 2000.00 | 2025-02-18 14:55:36 |
+------------+--------------+---------+---------------------+
3 rows in set (0.00 sec)
```

一般的には、トランザクションの変更はコミットが開始される前にトランザクションログに書き込まれるため、コミット中にsqlサーバーがダウンしたとしてもログから復旧が可能である。