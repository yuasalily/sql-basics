テーブルは13-1で準備したものをそのまま使用する。累計や移動平均、前後のレコードの比較を行いたい場合、`ORDER BY`を使用できる。ウィンドウ関数内で`ORDER BY`を用いると、デフォルトでは現在のレコードを含めて`ORDER BY`で上に来るレコードを集計した値を求める動きになる。以下のクエリでは日付順に累積売り上げを求めている。
```
mysql> select sale_date,
    -> sum(total_price) over(order by sale_date) as "日ごとの累積売上"
    -> from sales;
+------------+--------------------------+
| sale_date  | 日ごとの累積売上         |
+------------+--------------------------+
| 2024-02-01 |                 47800.00 |
| 2024-02-01 |                 47800.00 |
| 2024-02-01 |                 47800.00 |
| 2024-02-01 |                 47800.00 |
| 2024-02-01 |                 47800.00 |
| 2024-02-01 |                 47800.00 |
| 2024-02-02 |                101000.00 |
| 2024-02-02 |                101000.00 |
| 2024-02-02 |                101000.00 |
| 2024-02-02 |                101000.00 |
| 2024-02-02 |                101000.00 |
| 2024-02-02 |                101000.00 |
| 2024-02-03 |                159000.00 |
| 2024-02-03 |                159000.00 |
| 2024-02-03 |                159000.00 |
| 2024-02-03 |                159000.00 |
| 2024-02-03 |                159000.00 |
| 2024-02-03 |                159000.00 |
| 2024-02-04 |                211600.00 |
| 2024-02-04 |                211600.00 |
| 2024-02-04 |                211600.00 |
| 2024-02-04 |                211600.00 |
| 2024-02-04 |                211600.00 |
| 2024-02-04 |                211600.00 |
| 2024-02-05 |                287800.00 |
| 2024-02-05 |                287800.00 |
| 2024-02-05 |                287800.00 |
| 2024-02-05 |                287800.00 |
| 2024-02-05 |                287800.00 |
| 2024-02-05 |                287800.00 |
| 2024-02-06 |                341800.00 |
| 2024-02-06 |                341800.00 |
| 2024-02-06 |                341800.00 |
| 2024-02-06 |                341800.00 |
| 2024-02-06 |                341800.00 |
| 2024-02-06 |                341800.00 |
| 2024-02-07 |                416600.00 |
| 2024-02-07 |                416600.00 |
| 2024-02-07 |                416600.00 |
| 2024-02-07 |                416600.00 |
| 2024-02-07 |                416600.00 |
| 2024-02-07 |                416600.00 |
| 2024-02-08 |                446800.00 |
| 2024-02-08 |                446800.00 |
| 2024-02-08 |                446800.00 |
| 2024-02-09 |                473800.00 |
| 2024-02-09 |                473800.00 |
| 2024-02-09 |                473800.00 |
| 2024-02-10 |                505900.00 |
| 2024-02-10 |                505900.00 |
| 2024-02-10 |                505900.00 |
| 2024-02-11 |                536200.00 |
| 2024-02-11 |                536200.00 |
| 2024-02-11 |                536200.00 |
| 2024-02-12 |                571100.00 |
| 2024-02-12 |                571100.00 |
| 2024-02-12 |                571100.00 |
| 2024-02-13 |                597600.00 |
| 2024-02-13 |                597600.00 |
| 2024-02-13 |                597600.00 |
| 2024-02-14 |                624600.00 |
| 2024-02-14 |                624600.00 |
| 2024-02-14 |                624600.00 |
| 2024-02-15 |                660800.00 |
| 2024-02-15 |                660800.00 |
| 2024-02-15 |                660800.00 |
| 2024-02-16 |                687600.00 |
| 2024-02-16 |                687600.00 |
| 2024-02-16 |                687600.00 |
| 2024-02-17 |                719100.00 |
| 2024-02-17 |                719100.00 |
| 2024-02-17 |                719100.00 |
| 2024-02-18 |                750200.00 |
| 2024-02-18 |                750200.00 |
| 2024-02-18 |                750200.00 |
| 2024-02-19 |                777600.00 |
| 2024-02-19 |                777600.00 |
| 2024-02-19 |                777600.00 |
| 2024-02-20 |                805900.00 |
| 2024-02-20 |                805900.00 |
| 2024-02-20 |                805900.00 |
| 2024-02-21 |                836100.00 |
| 2024-02-21 |                836100.00 |
| 2024-02-21 |                836100.00 |
| 2024-02-22 |                875700.00 |
| 2024-02-22 |                875700.00 |
| 2024-02-22 |                875700.00 |
| 2024-02-23 |                898200.00 |
| 2024-02-23 |                898200.00 |
| 2024-02-23 |                898200.00 |
| 2024-02-24 |                932700.00 |
| 2024-02-24 |                932700.00 |
| 2024-02-24 |                932700.00 |
| 2024-02-25 |                959300.00 |
| 2024-02-25 |                959300.00 |
| 2024-02-25 |                959300.00 |
| 2024-02-26 |                985100.00 |
| 2024-02-26 |                985100.00 |
| 2024-02-26 |                985100.00 |
| 2024-02-27 |               1019500.00 |
| 2024-02-27 |               1019500.00 |
| 2024-02-27 |               1019500.00 |
| 2024-02-28 |               1048200.00 |
| 2024-02-28 |               1048200.00 |
| 2024-02-28 |               1048200.00 |
+------------+--------------------------+

-- 見やすいよう上のテーブルで重複排除を行う
mysql> select distinct sale_date,
    -> sum(total_price) over(order by sale_date) as "日ごとの累積売上"
    -> from sales;
+------------+--------------------------+
| sale_date  | 日ごとの累積売上         |
+------------+--------------------------+
| 2024-02-01 |                 47800.00 |
| 2024-02-02 |                101000.00 |
| 2024-02-03 |                159000.00 |
| 2024-02-04 |                211600.00 |
| 2024-02-05 |                287800.00 |
| 2024-02-06 |                341800.00 |
| 2024-02-07 |                416600.00 |
| 2024-02-08 |                446800.00 |
| 2024-02-09 |                473800.00 |
| 2024-02-10 |                505900.00 |
| 2024-02-11 |                536200.00 |
| 2024-02-12 |                571100.00 |
| 2024-02-13 |                597600.00 |
| 2024-02-14 |                624600.00 |
| 2024-02-15 |                660800.00 |
| 2024-02-16 |                687600.00 |
| 2024-02-17 |                719100.00 |
| 2024-02-18 |                750200.00 |
| 2024-02-19 |                777600.00 |
| 2024-02-20 |                805900.00 |
| 2024-02-21 |                836100.00 |
| 2024-02-22 |                875700.00 |
| 2024-02-23 |                898200.00 |
| 2024-02-24 |                932700.00 |
| 2024-02-25 |                959300.00 |
| 2024-02-26 |                985100.00 |
| 2024-02-27 |               1019500.00 |
| 2024-02-28 |               1048200.00 |
+------------+--------------------------+

-- 2024-02-01には2024-02-01の売り上げ合計が入っている
mysql> select sum(total_price)
    -> from sales
    -> where sale_date between "2024-02-01" and "2024-02-01";
+------------------+
| sum(total_price) |
+------------------+
|         47800.00 |
+------------------+

-- 2024-02-02には2024-02-01から2024-02-02の売り上げ合計が入っている
mysql> select sum(total_price)
    -> from sales
    -> where sale_date between "2024-02-01" and "2024-02-02";
+------------------+
| sum(total_price) |
+------------------+
|        101000.00 |
+------------------+

-- 2024-02-03には2024-02-01から2024-02-03の売り上げ合計が入っている。以降も同じように続いていく。
mysql> select sum(total_price)
    -> from sales
    -> where sale_date between "2024-02-01" and "2024-02-03";
+------------------+
| sum(total_price) |
+------------------+
|        159000.00 |
+------------------+
```
`PARTITION BY`と`ORDER BY`を同時に使うと、グループ化した上で集計を行う。以下のクエリでは商品ごとの累積売り上げを取得している。
```
mysql> select distinct sale_date, product_name,
    -> sum(total_price) over(
    ->     partition by product_name
    ->     order by sale_date
    ->     ) as "商品ごとの累積売り上げ"
    -> from sales;
+------------+--------------+-----------------------------------+
| sale_date  | product_name | 商品ごとの累積売り上げ            |
+------------+--------------+-----------------------------------+
| 2024-02-01 | Product A    |                          20000.00 |
| 2024-02-02 | Product A    |                          44000.00 |
| 2024-02-03 | Product A    |                          62000.00 |
| 2024-02-04 | Product A    |                          84000.00 |
| 2024-02-05 | Product A    |                         114000.00 |
| 2024-02-06 | Product A    |                         130000.00 |
| 2024-02-07 | Product A    |                         156000.00 |
| 2024-02-08 | Product A    |                         170000.00 |
| 2024-02-09 | Product A    |                         177000.00 |
| 2024-02-10 | Product A    |                         187000.00 |
| 2024-02-11 | Product A    |                         199000.00 |
| 2024-02-12 | Product A    |                         208000.00 |
| 2024-02-13 | Product A    |                         216000.00 |
| 2024-02-14 | Product A    |                         230000.00 |
| 2024-02-15 | Product A    |                         241000.00 |
| 2024-02-16 | Product A    |                         251000.00 |
| 2024-02-17 | Product A    |                         264000.00 |
| 2024-02-18 | Product A    |                         273000.00 |
| 2024-02-19 | Product A    |                         285000.00 |
| 2024-02-20 | Product A    |                         295000.00 |
| 2024-02-21 | Product A    |                         306000.00 |
| 2024-02-22 | Product A    |                         321000.00 |
| 2024-02-23 | Product A    |                         329000.00 |
| 2024-02-24 | Product A    |                         342000.00 |
| 2024-02-25 | Product A    |                         354000.00 |
| 2024-02-26 | Product A    |                         363000.00 |
| 2024-02-27 | Product A    |                         373000.00 |
| 2024-02-28 | Product A    |                         384000.00 |
| 2024-02-01 | Product B    |                          15000.00 |
| 2024-02-02 | Product B    |                          33000.00 |
| 2024-02-03 | Product B    |                          57000.00 |
| 2024-02-04 | Product B    |                          78000.00 |
| 2024-02-05 | Product B    |                         105000.00 |
| 2024-02-06 | Product B    |                         135000.00 |
| 2024-02-07 | Product B    |                         171000.00 |
| 2024-02-08 | Product B    |                         180000.00 |
| 2024-02-09 | Product B    |                         192000.00 |
| 2024-02-10 | Product B    |                         208500.00 |
| 2024-02-11 | Product B    |                         222000.00 |
| 2024-02-12 | Product B    |                         241500.00 |
| 2024-02-13 | Product B    |                         252000.00 |
| 2024-02-14 | Product B    |                         261000.00 |
| 2024-02-15 | Product B    |                         279000.00 |
| 2024-02-16 | Product B    |                         291000.00 |
| 2024-02-17 | Product B    |                         301500.00 |
| 2024-02-18 | Product B    |                         318000.00 |
| 2024-02-19 | Product B    |                         327000.00 |
| 2024-02-20 | Product B    |                         340500.00 |
| 2024-02-21 | Product B    |                         352500.00 |
| 2024-02-22 | Product B    |                         367500.00 |
| 2024-02-23 | Product B    |                         378000.00 |
| 2024-02-24 | Product B    |                         391500.00 |
| 2024-02-25 | Product B    |                         400500.00 |
| 2024-02-26 | Product B    |                         412500.00 |
| 2024-02-27 | Product B    |                         430500.00 |
| 2024-02-28 | Product B    |                         441000.00 |
| 2024-02-01 | Product C    |                          12800.00 |
| 2024-02-02 | Product C    |                          24000.00 |
| 2024-02-03 | Product C    |                          40000.00 |
| 2024-02-04 | Product C    |                          49600.00 |
| 2024-02-05 | Product C    |                          68800.00 |
| 2024-02-06 | Product C    |                          76800.00 |
| 2024-02-07 | Product C    |                          89600.00 |
| 2024-02-08 | Product C    |                          96800.00 |
| 2024-02-09 | Product C    |                         104800.00 |
| 2024-02-10 | Product C    |                         110400.00 |
| 2024-02-11 | Product C    |                         115200.00 |
| 2024-02-12 | Product C    |                         121600.00 |
| 2024-02-13 | Product C    |                         129600.00 |
| 2024-02-14 | Product C    |                         133600.00 |
| 2024-02-15 | Product C    |                         140800.00 |
| 2024-02-16 | Product C    |                         145600.00 |
| 2024-02-17 | Product C    |                         153600.00 |
| 2024-02-18 | Product C    |                         159200.00 |
| 2024-02-19 | Product C    |                         165600.00 |
| 2024-02-20 | Product C    |                         170400.00 |
| 2024-02-21 | Product C    |                         177600.00 |
| 2024-02-22 | Product C    |                         187200.00 |
| 2024-02-23 | Product C    |                         191200.00 |
| 2024-02-24 | Product C    |                         199200.00 |
| 2024-02-25 | Product C    |                         204800.00 |
| 2024-02-26 | Product C    |                         209600.00 |
| 2024-02-27 | Product C    |                         216000.00 |
| 2024-02-28 | Product C    |                         223200.00 |
+------------+--------------+-----------------------------------+

-- 1つ目のレコードはProduct Aの2024-02-01の売り上げ
mysql> select sum(total_price)
    -> from sales
    -> where sale_date between "2024-02-01" and "2024-02-01"
    -> and product_name = "Product A";
+------------------+
| sum(total_price) |
+------------------+
|         20000.00 |
+------------------+

-- 2つ目のレコードはProduct Aの2024-02-01からから2024-02-02の売り上げ
mysql> select sum(total_price)
    -> from sales
    -> where sale_date between "2024-02-01" and "2024-02-02"
    -> and product_name = "Product A";
+------------------+
| sum(total_price) |
+------------------+
|         44000.00 |
+------------------+

-- 3つ目のレコードはProduct Aの2024-02-01からから2024-02-03の売り上げ
mysql> select sum(total_price)
    -> from sales
    -> where sale_date between "2024-02-01" and "2024-02-03"
    -> and product_name = "Product A";
+------------------+
| sum(total_price) |
+------------------+
|         62000.00 |
+------------------+
```
自身で集計範囲（フレームと呼ぶ）を指定したい場合、`[ROWS | RANGE] BETWEEN <start> AMD <end>`を使用する。`ROWS`,`RANGE`と`<start>/<end>`を組み合わせた際の挙動は下の表のとおりである。これらはフレーム句と呼ばれる。
|                     | ROWS                         | RANGE                                                    |
| ------------------- | ---------------------------- | -------------------------------------------------------- |
| UNBOUNDED PRECEDING | パーティション内の最初の行。 | ソートキーの最小値。結果としてパーティションの最初の行。 |
| <n> PRECEDING       | n行前。                      | 現在の行の値 - n。                                       |
| CURRENT ROW         | 現在の行。                   | 現在の行と同じ値の行（複数行あればそれも含む）。         |
| <n> FOLLOWING       | n行後。                      | 現在の行の値 + n。                                       |
| UNBOUNDED FOLLOWING | パーティション内の最後の行。 | ソートキーの最大値。結果としてパーティションの最後の行。 |

`ROWS`を用いた場合、行数に基づいて範囲を決定する。以下のクエリでは3つ前までのidの平均売り上げを取得している。
```
mysql> select id,
    -> avg(total_price) over (
    ->     order by id
    ->     rows between 2 preceding and current row
    ->     ) as "3つ前までのidの平均売り上げ"
    -> from sales
    -> limit 10;
+----+-----------------------------------------+
| id | 3つ前までのidの平均売り上げ             |
+----+-----------------------------------------+
|  1 |                            10000.000000 |
|  2 |                             8750.000000 |
|  3 |                             7966.666667 |
|  4 |                             8633.333333 |
|  5 |                             9133.333333 |
|  6 |                             8866.666667 |
|  7 |                             7866.666667 |
|  8 |                             8866.666667 |
|  9 |                             9666.666667 |
| 10 |                            10333.333333 |
+----+-----------------------------------------+

-- id = 1の場合はそれより小さいものがないのでid = 1のみ。
mysql> select avg(total_price)
    -> from sales
    -> where id = 1;
+------------------+
| avg(total_price) |
+------------------+
|     10000.000000 |
+------------------+

-- id = 2の場合は3つ前のidまでは足りないのでないのでid = 1, 2の平均。
mysql> select avg(total_price)
    -> from sales
    -> where id in (1, 2);
+------------------+
| avg(total_price) |
+------------------+
|      8750.000000 |
+------------------+

-- id = 3の場合はid = 1, 2, 3の平均。
mysql> select avg(total_price)
    -> from sales
    -> where id in (1, 2, 3);
+------------------+
| avg(total_price) |
+------------------+
|      7966.666667 |
+------------------+

-- id = 4の場合はid = 2, 3, 4の平均。
mysql> select avg(total_price)
    -> from sales
    -> where id in (2, 3, 4);
+------------------+
| avg(total_price) |
+------------------+
|      8633.333333 |
+------------------+

-- idが5以上の場合も同様に続いていく。
```
`RANGE`を用いた場合、カラムの値に基づいて集計範囲を決定する。以下のクエリでは売上個数が2個まで少ない取引の個数平均を取得している。`ROW`と異なり、`quantity_sold`の差が2以下のレコードが集計に含まれていることがわかる。
```
mysql> select quantity_sold,
    -> avg(quantity_sold) over(
    ->     order by quantity_sold
    ->     range between 2 preceding and current row
    -> ) as "売上個数の差が2以下の取引の個数平均(RANGE)",
    -> avg(quantity_sold) over(
    ->     order by quantity_sold
    ->     rows between 2 preceding and current row
    -> ) as "2行前までの取引の個数平均(ROWS)"
    -> from sales;
+---------------+-------------------------------------------------------------+---------------------------------------------+
| quantity_sold | 売上個数の差が2以下の取引の個数平均(RANGE)                  | 2行前までの取引の個数平均(ROWS)             |
+---------------+-------------------------------------------------------------+---------------------------------------------+
|             5 |                                                      5.0000 |                                      5.0000 |
|             5 |                                                      5.0000 |                                      5.0000 |
|             5 |                                                      5.0000 |                                      5.0000 |
|             5 |                                                      5.0000 |                                      5.0000 |
|             5 |                                                      5.0000 |                                      5.0000 |
|             5 |                                                      5.0000 |                                      5.0000 |
|             6 |                                                      5.6667 |                                      5.3333 |
|             6 |                                                      5.6667 |                                      5.6667 |
|             6 |                                                      5.6667 |                                      6.0000 |
|             6 |                                                      5.6667 |                                      6.0000 |
|             6 |                                                      5.6667 |                                      6.0000 |
|             6 |                                                      5.6667 |                                      6.0000 |
|             6 |                                                      5.6667 |                                      6.0000 |
|             6 |                                                      5.6667 |                                      6.0000 |
|             6 |                                                      5.6667 |                                      6.0000 |
|             6 |                                                      5.6667 |                                      6.0000 |
|             6 |                                                      5.6667 |                                      6.0000 |
|             6 |                                                      5.6667 |                                      6.0000 |
|             7 |                                                      6.2000 |                                      6.3333 |
|             7 |                                                      6.2000 |                                      6.6667 |
|             7 |                                                      6.2000 |                                      7.0000 |
|             7 |                                                      6.2000 |                                      7.0000 |
|             7 |                                                      6.2000 |                                      7.0000 |
|             7 |                                                      6.2000 |                                      7.0000 |
|             7 |                                                      6.2000 |                                      7.0000 |
|             7 |                                                      6.2000 |                                      7.0000 |
|             7 |                                                      6.2000 |                                      7.0000 |
|             7 |                                                      6.2000 |                                      7.0000 |
|             7 |                                                      6.2000 |                                      7.0000 |
|             7 |                                                      6.2000 |                                      7.0000 |
|             8 |                                                      7.1220 |                                      7.3333 |
|             8 |                                                      7.1220 |                                      7.6667 |
|             8 |                                                      7.1220 |                                      8.0000 |
|             8 |                                                      7.1220 |                                      8.0000 |
|             8 |                                                      7.1220 |                                      8.0000 |
|             8 |                                                      7.1220 |                                      8.0000 |
|             8 |                                                      7.1220 |                                      8.0000 |
|             8 |                                                      7.1220 |                                      8.0000 |
|             8 |                                                      7.1220 |                                      8.0000 |
|             8 |                                                      7.1220 |                                      8.0000 |
|             8 |                                                      7.1220 |                                      8.0000 |
|             8 |                                                      7.1220 |                                      8.0000 |
|             8 |                                                      7.1220 |                                      8.0000 |
|             8 |                                                      7.1220 |                                      8.0000 |
|             8 |                                                      7.1220 |                                      8.0000 |
|             8 |                                                      7.1220 |                                      8.0000 |
|             8 |                                                      7.1220 |                                      8.0000 |
|             9 |                                                      8.0465 |                                      8.3333 |
|             9 |                                                      8.0465 |                                      8.6667 |
|             9 |                                                      8.0465 |                                      9.0000 |
|             9 |                                                      8.0465 |                                      9.0000 |
|             9 |                                                      8.0465 |                                      9.0000 |
|             9 |                                                      8.0465 |                                      9.0000 |
|             9 |                                                      8.0465 |                                      9.0000 |
|             9 |                                                      8.0465 |                                      9.0000 |
|             9 |                                                      8.0465 |                                      9.0000 |
|             9 |                                                      8.0465 |                                      9.0000 |
|             9 |                                                      8.0465 |                                      9.0000 |
|             9 |                                                      8.0465 |                                      9.0000 |
|             9 |                                                      8.0465 |                                      9.0000 |
|             9 |                                                      8.0465 |                                      9.0000 |
|            10 |                                                      8.9565 |                                      9.3333 |
|            10 |                                                      8.9565 |                                      9.6667 |
|            10 |                                                      8.9565 |                                     10.0000 |
|            10 |                                                      8.9565 |                                     10.0000 |
|            10 |                                                      8.9565 |                                     10.0000 |
|            10 |                                                      8.9565 |                                     10.0000 |
|            10 |                                                      8.9565 |                                     10.0000 |
|            10 |                                                      8.9565 |                                     10.0000 |
|            10 |                                                      8.9565 |                                     10.0000 |
|            10 |                                                      8.9565 |                                     10.0000 |
|            10 |                                                      8.9565 |                                     10.0000 |
|            10 |                                                      8.9565 |                                     10.0000 |
|            10 |                                                      8.9565 |                                     10.0000 |
|            10 |                                                      8.9565 |                                     10.0000 |
|            10 |                                                      8.9565 |                                     10.0000 |
|            11 |                                                      9.8056 |                                     10.3333 |
|            11 |                                                      9.8056 |                                     10.6667 |
|            11 |                                                      9.8056 |                                     11.0000 |
|            11 |                                                      9.8056 |                                     11.0000 |
|            11 |                                                      9.8056 |                                     11.0000 |
|            11 |                                                      9.8056 |                                     11.0000 |
|            11 |                                                      9.8056 |                                     11.0000 |
|            12 |                                                     10.9118 |                                     11.3333 |
|            12 |                                                     10.9118 |                                     11.6667 |
|            12 |                                                     10.9118 |                                     12.0000 |
|            12 |                                                     10.9118 |                                     12.0000 |
|            12 |                                                     10.9118 |                                     12.0000 |
|            12 |                                                     10.9118 |                                     12.0000 |
|            12 |                                                     10.9118 |                                     12.0000 |
|            12 |                                                     10.9118 |                                     12.0000 |
|            12 |                                                     10.9118 |                                     12.0000 |
|            12 |                                                     10.9118 |                                     12.0000 |
|            12 |                                                     10.9118 |                                     12.0000 |
|            12 |                                                     10.9118 |                                     12.0000 |
|            13 |                                                     11.9167 |                                     12.3333 |
|            13 |                                                     11.9167 |                                     12.6667 |
|            13 |                                                     11.9167 |                                     13.0000 |
|            13 |                                                     11.9167 |                                     13.0000 |
|            13 |                                                     11.9167 |                                     13.0000 |
|            14 |                                                     12.4737 |                                     13.3333 |
|            14 |                                                     12.4737 |                                     13.6667 |
|            15 |                                                     13.8000 |                                     14.3333 |
|            15 |                                                     13.8000 |                                     14.6667 |
|            15 |                                                     13.8000 |                                     15.0000 |
+---------------+-------------------------------------------------------------+---------------------------------------------+

-- 見やすいように重複排除
mysql> select distinct quantity_sold,
    -> avg(quantity_sold) over(
    ->     order by quantity_sold
    ->     range between 2 preceding and current row
    -> ) as "売上個数の差が2以下の取引の個数平均(RANGE)"
    -> from sales;
+---------------+-------------------------------------------------------------+
| quantity_sold | 売上個数の差が2以下の取引の個数平均(RANGE)                  |
+---------------+-------------------------------------------------------------+
|             5 |                                                      5.0000 |
|             6 |                                                      5.6667 |
|             7 |                                                      6.2000 |
|             8 |                                                      7.1220 |
|             9 |                                                      8.0465 |
|            10 |                                                      8.9565 |
|            11 |                                                      9.8056 |
|            12 |                                                     10.9118 |
|            13 |                                                     11.9167 |
|            14 |                                                     12.4737 |
|            15 |                                                     13.8000 |
+---------------+-------------------------------------------------------------+

-- quantity_sold = 5の場合はそれ以下が存在しないのでquantity_sold = 5の平均
mysql> select avg(quantity_sold)
    -> from sales
    -> where quantity_sold between 5 and 5;
+--------------------+
| avg(quantity_sold) |
+--------------------+
|             5.0000 |
+--------------------+

-- quantity_sold = 6の場合はquantity_sold = 5, 6の平均
mysql> select avg(quantity_sold)
    -> from sales
    -> where quantity_sold between 5 and 6;
+--------------------+
| avg(quantity_sold) |
+--------------------+
|             5.6667 |
+--------------------+

-- quantity_sold = 7の場合はquantity_sold = 5, 6, 7の平均
mysql> select avg(quantity_sold)
    -> from sales
    -> where quantity_sold between 5 and 7;
+--------------------+
| avg(quantity_sold) |
+--------------------+
|             6.2000 |
+--------------------+

-- quantity_sold = 8の場合はquantity_sold = 6, 7, 8の平均
mysql> select avg(quantity_sold)
    -> from sales
    -> where quantity_sold between 6 and 8;
+--------------------+
| avg(quantity_sold) |
+--------------------+
|             7.1220 |
+--------------------+

-- 以降も同様に続く。
```

日付ごとの集計を行いたい場合、日付をそのまま用いて集計するのは難しいので、先に日付で集計したテーブルを用意してから、さらに集計するようにする。以下のクエリでは日付ごとの合計売上を仮のテーブルに格納し、1行に1日分のデータが格納されていることを保証したうえで3日間の移動平均を取得している。
```
mysql> with daily as (
    ->     select sale_date, sum(total_price) as daily_sum
    ->     from sales
    ->     group by sale_date
    -> )
    -> select sale_date,
    -> avg(daily_sum) over(
    ->     order by sale_date
    ->     rows between 1 preceding and 1 following
    -> ) as "3日間の売上移動平均"
    -> from daily;
+------------+------------------------------+
| sale_date  | 3日間の売上移動平均          |
+------------+------------------------------+
| 2024-02-01 |                 50500.000000 |
| 2024-02-02 |                 53000.000000 |
| 2024-02-03 |                 54600.000000 |
| 2024-02-04 |                 62266.666667 |
| 2024-02-05 |                 60933.333333 |
| 2024-02-06 |                 68333.333333 |
| 2024-02-07 |                 53000.000000 |
| 2024-02-08 |                 44000.000000 |
| 2024-02-09 |                 29766.666667 |
| 2024-02-10 |                 29800.000000 |
| 2024-02-11 |                 32433.333333 |
| 2024-02-12 |                 30566.666667 |
| 2024-02-13 |                 29466.666667 |
| 2024-02-14 |                 29900.000000 |
| 2024-02-15 |                 30000.000000 |
| 2024-02-16 |                 31500.000000 |
| 2024-02-17 |                 29800.000000 |
| 2024-02-18 |                 30000.000000 |
| 2024-02-19 |                 28933.333333 |
| 2024-02-20 |                 28633.333333 |
| 2024-02-21 |                 32700.000000 |
| 2024-02-22 |                 30766.666667 |
| 2024-02-23 |                 32200.000000 |
| 2024-02-24 |                 27866.666667 |
| 2024-02-25 |                 28966.666667 |
| 2024-02-26 |                 28933.333333 |
| 2024-02-27 |                 29633.333333 |
| 2024-02-28 |                 31550.000000 |
+------------+------------------------------+
```

`ORDER BY`を指定してフレーム句を省略した場合、デフォルトでは`RANGE BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW`となり、現在のレコードを含めて`ORDER BY`で上に来るレコードを集計した値を求める動きになる。`ORDER BY`がない状態でフレーム句を省略した場合、`ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING` となり、全区間が集計される。
